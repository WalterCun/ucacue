---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
---

<Layout title="UCACUE - Inscripción" description="Formulario para registrar inscripción.">
  <Navbar title="UCACUE" links={[{ name: "Inscripción", href: "/inscripcion" }, { name: "Revisión", href: "/revision" }]} />
  <main class="container-custom py-10">
    <h1 class="text-3xl font-bold mb-6">Formulario de inscripción</h1>

    <form id="form-inscripcion" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-3xl">
      <div class="md:col-span-2">
        <label class="label" for="nombre">Nombres completos</label>
        <input id="nombre" name="nombre" class="input" placeholder="Ej: Walter Cun Bustamante" required />
      </div>
      <div>
        <label class="label" for="cedula">Cédula</label>
        <input id="cedula" name="cedula" class="input" required />
        <p id="cedula-help" class="text-xs mt-1 text-gray-500">Ingrese 10 dígitos. Se validará automáticamente.</p>
      </div>
      <div>
        <label class="label" for="email">Correo electrónico</label>
        <input id="email" name="email" type="email" class="input" required />
      </div>
      <div>
        <label class="label" for="colegio_id">Colegio</label>
        <select id="colegio_id" name="colegio_id" class="input" required>
          <option value="">Seleccione un colegio</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Se aplicará un 3% de descuento si el colegio es Fiscal o Fiscomisional.</p>
      </div>
      <div>
        <label class="label" for="carrera_id">Carrera</label>
        <select id="carrera_id" name="carrera_id" class="input" required>
          <option value="">Seleccione una carrera</option>
        </select>
      </div>

      <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-3 mt-2 bg-white border rounded p-3">
        <div class="rounded p-2 bg-blue-50">
          <div class="text-xs text-blue-700">Subtotal</div>
          <div id="subtotal-view" class="text-lg font-semibold text-blue-800">$100.00</div>
        </div>
        <div class="rounded p-2 bg-emerald-50">
          <div class="text-xs text-emerald-700">Descuento</div>
          <div id="descuento-view" class="text-lg font-semibold text-emerald-800">$0.00</div>
        </div>
        <div class="rounded p-2 bg-indigo-50">
          <div class="text-xs text-indigo-700">Total a pagar</div>
          <div id="total-view" class="text-lg font-semibold text-indigo-800">$100.00</div>
        </div>
      </div>

      <div class="md:col-span-2 flex gap-2 mt-2">
        <button id="btn-submit" type="submit" class="btn-primary">Registrar</button>
        <a href="/estadisticas-de-inscripciones" class="btn-secondary">Ver estadísticas</a>
      </div>

      <p id="msg" class="md:col-span-2 text-sm mt-2"></p>
    </form>
  </main>
</Layout>

<script>
  const BASE_VALUE = 100;
  const CACHE_KEY = 'inscripcion_cache_v1';

  function showMessage(text, ok = true) {
    const el = document.getElementById('msg');
    el.textContent = text;
    el.className = `md:col-span-2 text-sm mt-2 ${ok ? 'text-green-700' : 'text-red-600'}`;
  }

  function validarEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    return re.test(String(email || '').trim());
  }

  // Validador de cédula ecuatoriana (10 dígitos, módulo 10)
  function validarCedulaEc(cedula) {
    const c = String(cedula || '').trim();
    if (!/^\d{10}$/.test(c)) return false;
    const provincia = parseInt(c.slice(0, 2), 10);
    if (!((provincia >= 1 && provincia <= 24) || provincia === 30)) return false;
    const digitoVerificador = parseInt(c[9], 10);
    let suma = 0;
    for (let i = 0; i < 9; i++) {
      let num = parseInt(c[i], 10);
      if (i % 2 === 0) { // posiciones impares 0-based
        num *= 2;
        if (num > 9) num -= 9;
      }
      suma += num;
    }
    const decenaSuperior = Math.ceil(suma / 10) * 10;
    const verificador = (decenaSuperior - suma) % 10;
    return verificador === digitoVerificador;
  }

  async function enviar(payload) {
    // Limpia el cache sólo cuando el backend confirma el guardado
    const res = await fetch('http://localhost:8080/inscripciones', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const text = await res.text().catch(()=>'');
      throw new Error(`Error ${res.status}: ${text || res.statusText}`);
    }
    return res.json().catch(()=>({ ok: true }));
  }

  function actualizarTotales() {
    const subtotal = Number(BASE_VALUE.toFixed(2));
    const sel = document.getElementById('colegio_id');
    const tipo = sel?.selectedOptions?.[0]?.dataset?.tipo || '';
    const t = String(tipo).toLowerCase();
    const aplica = t.includes('fiscal') || t.includes('fiscomisional') || t.includes('cominional');
    const descuento = aplica ? Number((BASE_VALUE * 0.03).toFixed(2)) : 0;
    const total = Number((subtotal - descuento).toFixed(2));
    document.getElementById('subtotal-view').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('descuento-view').textContent = `$${descuento.toFixed(2)}`;
    document.getElementById('total-view').textContent = `$${total.toFixed(2)}`;
    return { subtotal, descuento, total };
  }

  async function cargarDropdowns() {
    const selColegio = document.getElementById('colegio_id');
    const selCarrera = document.getElementById('carrera_id');
    try {
      const [respColegios, respCarreras] = await Promise.all([
        fetch('http://localhost:8080/colegios'),
        fetch('http://localhost:8080/carreras')
      ]);
      const colegios = respColegios.ok ? await respColegios.json() : [];
      const carreras = respCarreras.ok ? await respCarreras.json() : [];
      // poblar colegios
      selColegio.innerHTML = '<option value="">Seleccione un colegio</option>' +
        (Array.isArray(colegios) ? colegios.map(c => `<option value="${c.id}" data-tipo="${c.tipo || ''}">${c.nombre} - ${c.ciudad}</option>`).join('') : '');
      // poblar carreras
      selCarrera.innerHTML = '<option value="">Seleccione una carrera</option>' +
        (Array.isArray(carreras) ? carreras.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('') : '');
      actualizarTotales();
    } catch (e) {
      console.error('Error cargando catálogos', e);
    }
  }

  function setSubmitting(submitting) {
    const btn = document.getElementById('btn-submit');
    if (btn) { btn.disabled = !!submitting; btn.textContent = submitting ? 'Enviando...' : 'Registrar'; }
  }

  document.getElementById('colegio_id')?.addEventListener('change', () => { actualizarTotales(); saveCacheFromForm(); });

  // Validación en tiempo real de cédula
  const cedulaInput = document.getElementById('cedula');
  const cedulaHelp = document.getElementById('cedula-help');
  function applyCedulaFeedback(ok) {
    if (!cedulaInput) return;
    cedulaInput.classList.toggle('border-red-500', !ok);
    cedulaInput.classList.toggle('focus:border-red-500', !ok);
    cedulaInput.classList.toggle('border-emerald-500', ok);
    if (cedulaHelp) {
      cedulaHelp.textContent = ok ? 'Cédula válida.' : 'Cédula inválida. Debe tener 10 dígitos y pasar la validación.';
      cedulaHelp.className = 'text-xs mt-1 ' + (ok ? 'text-emerald-700' : 'text-red-600');
    }
  }
  cedulaInput?.addEventListener('input', (e) => {
    saveCacheFromForm();
    // permitir solo números y máximo 10
    const val = e.target.value.replace(/\D/g, '').slice(0, 10);
    if (val !== e.target.value) e.target.value = val;
    if (val.length === 0) {
      // estado neutro
      if (cedulaHelp) { cedulaHelp.textContent = 'Ingrese 10 dígitos. Se validará automáticamente.'; cedulaHelp.className = 'text-xs mt-1 text-gray-500'; }
      cedulaInput.classList.remove('border-red-500','focus:border-red-500','border-emerald-500');
      setSubmitEnabled(false);
      return;
    }
    const ok = validarCedulaEc(val);
    applyCedulaFeedback(ok);
    setSubmitEnabled(ok);
  });

  function setSubmitEnabled(enabled) {
    const btn = document.getElementById('btn-submit');
    if (!btn) return;
    btn.disabled = !enabled;
  }

  function saveCacheFromForm() {
    try {
      const form = document.getElementById('form-inscripcion');
      if (!form) return;
      const data = Object.fromEntries(new FormData(form).entries());
      const { subtotal, descuento, total } = actualizarTotales();
      const cache = {
        version: 1,
        data,
        totales: { subtotal, descuento, total },
        ts: Date.now()
      };
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
    } catch (e) {
      // noop
    }
  }

  function loadCacheIntoForm() {
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return;
      const cache = JSON.parse(raw);
      const data = cache?.data || {};
      for (const [k, v] of Object.entries(data)) {
        const el = document.querySelector(`[name="${k}"]`);
        if (el) el.value = v;
      }
    } catch (e) {}
  }

  document.getElementById('form-inscripcion')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    // Validaciones
    if (!validarCedulaEc(data.cedula)) {
      showMessage('Cédula inválida. Verifique e intente nuevamente.', false);
      return;
    }
    if (!validarEmail(data.email)) {
      showMessage('Correo inválido.', false);
      return;
    }
    if (!data.colegio_id || !data.carrera_id) {
      showMessage('Seleccione colegio y carrera.', false);
      return;
    }

    const { subtotal, descuento, total } = actualizarTotales();

    const payload = {
      nombre: String(data.nombre || '').trim(),
      cedula: String(data.cedula || '').trim(),
      email: String(data.email || '').trim(),
      colegio_id: String(data.colegio_id || '').trim(),
      carrera_id: String(data.carrera_id || '').trim(),
      subtotal: String(subtotal),
      descuento: String(descuento),
      costo: String(total)
    };

    try {
      setSubmitting(true);
      showMessage('Enviando...', true);
      console.debug('Enviando payload:', payload);
      await enviar(payload);
      showMessage('Inscripción registrada correctamente.', true);
      form.reset();
      try { localStorage.removeItem(CACHE_KEY); } catch (e) {}
      await cargarDropdowns(); // recarga totales y selects
    } catch (err) {
      console.error(err);
      showMessage(err?.message || 'Ocurrió un error al registrar.', false);
    } finally {
      setSubmitting(false);
    }
  });

  // Guardar en cache al cambiar cualquier campo
  ['nombre','cedula','email','colegio_id','carrera_id'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', saveCacheFromForm);
    document.getElementById(id)?.addEventListener('blur', saveCacheFromForm);
    document.getElementById(id)?.addEventListener('input', saveCacheFromForm);
  });

  document.addEventListener('DOMContentLoaded', () => {
    // Intentar cargar desde cache antes de poblar selects
    loadCacheIntoForm();
    cargarDropdowns();
    actualizarTotales();
    // estado inicial: botón deshabilitado hasta cédula válida
    const btn = document.getElementById('btn-submit');
    if (btn) btn.disabled = true;
  });
</script>
