---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
---

<Layout title="UCACUE - Inscripciones" description="Resumen de inscripciones por carrera.">
  <Navbar title="UCACUE" links={[{ name: "Inscripción", href: "/inscripcion" }, { name: "Revisión", href: "/revision" }]} />
  <main class="container-custom py-10">
    <h1 class="text-3xl font-bold mb-6">Inscripciones por carrera</h1>
    <p class="text-sm text-gray-600 mb-4">Este resumen se construye a partir del JSON de <code>/inscripciones</code> entregado por el backend.</p>

    <div id="estado" class="text-sm text-gray-600 mb-3">Cargando...</div>
    <section id="contenedor" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></section>
  </main>
</Layout>

<script>
  async function fetchInscripciones() {
    try {
      const res = await fetch('http://localhost:8080/inscripciones');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    } catch (e) {
      console.error('No se pudieron cargar las inscripciones', e);
      return [];
    }
  }

  function agruparPorCarrera(registros) {
    const map = new Map(); // nombreCarrera -> conteo
    for (const r of registros) {
      const nombre = r?.carrera?.nombre || r?.carrera || 'Sin carrera';
      map.set(nombre, (map.get(nombre) || 0) + 1);
    }
    return map;
  }

  function renderResumen(map) {
    const cont = document.getElementById('contenedor');
    const estado = document.getElementById('estado');
    cont.innerHTML = '';

    const items = Array.from(map.entries())
      .sort((a,b) => b[1] - a[1]);

    if (items.length === 0) {
      estado.textContent = 'No hay inscripciones registradas.';
      return;
    }

    estado.textContent = `Total de carreras con inscripciones: ${items.length}`;

    for (const [nombre, cantidad] of items) {
      const card = document.createElement('div');
      card.className = 'p-4 bg-white border rounded-lg shadow-sm flex items-center justify-between';
      card.innerHTML = `<div><div class="text-sm text-gray-500">Carrera</div><div class="text-lg font-semibold">${nombre}</div></div><div class="text-3xl font-bold text-primary-600">${cantidad}</div>`;
      cont.appendChild(card);
    }
  }

  async function init() {
    const estado = document.getElementById('estado');
    estado.textContent = 'Cargando...';
    const registros = await fetchInscripciones();
    const agrupado = agruparPorCarrera(registros);
    renderResumen(agrupado);
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
